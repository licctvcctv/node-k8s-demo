<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>è®¢å•ç®¡ç†ç³»ç»Ÿ - äº‘åŸç”Ÿå•†åŸ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
        }
        
        .header {
            background: #722ed1;
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .nav-links {
            margin-top: 10px;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        .nav-links a:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .order-list {
            margin-top: 20px;
        }
        
        .order-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .order-id {
            font-size: 14px;
            color: #999;
        }
        
        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff7e6;
            color: #fa8c16;
        }
        
        .status-paid {
            background: #e6f7ff;
            color: #1890ff;
        }
        
        .status-shipped {
            background: #f6ffed;
            color: #52c41a;
        }
        
        .status-delivered {
            background: #f0f5ff;
            color: #2f54eb;
        }
        
        .status-cancelled {
            background: #fff1f0;
            color: #f5222d;
        }
        
        .order-items {
            margin: 15px 0;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #f0f0f0;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-weight: 500;
            color: #333;
        }
        
        .item-quantity {
            color: #666;
            font-size: 14px;
        }
        
        .item-price {
            color: #f5222d;
            font-weight: 600;
        }
        
        .order-total {
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }
        
        .total-amount {
            font-size: 20px;
            color: #f5222d;
            font-weight: 600;
        }
        
        .order-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
        }
        
        .btn-success {
            background: #52c41a;
            color: white;
        }
        
        .btn-success:hover {
            background: #73d13d;
        }
        
        .btn-danger {
            background: #ff4d4f;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff7875;
        }
        
        .add-order-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #722ed1;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }
        
        .add-order-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            text-align: center;
        }
        
        .success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        
        .error {
            background: #fff2e8;
            border: 1px solid #ffbb96;
            color: #fa541c;
        }
        
        .auth-notice {
            background: #fff7e6;
            border: 1px solid #ffd591;
            color: #fa8c16;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .filter-group {
            flex: 1;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: #722ed1;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .order-item-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .order-item-input input {
            flex: 1;
        }
        
        .remove-item-btn {
            background: #ff4d4f;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .add-item-btn {
            background: #52c41a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .product-select {
            flex: 2;
        }
        
        .date-info {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="nav-container"></div>
    <div class="header" style="display: none;">
        <h1>ğŸ›’ è®¢å•ç®¡ç†ç³»ç»Ÿ</h1>
        <p>äº‘åŸç”Ÿå¾®æœåŠ¡å•†åŸ - è®¢å•æœåŠ¡</p>
        <div class="nav-links">
            <a href="#" onclick="AUTH.redirectWithToken('http://'+window.location.hostname+':30081'); return false;">ğŸ‘¤ ç”¨æˆ·ä¸­å¿ƒ</a>
            <a href="#" onclick="AUTH.redirectWithToken('http://'+window.location.hostname+':30082'); return false;">ğŸ“¦ å•†å“ç®¡ç†</a>
        </div>
    </div>
    
    <div class="container">
        <div id="message"></div>
        
        <div id="authNotice" class="auth-notice" style="display: none;">
            âš ï¸ è¯·å…ˆ<a href="#" onclick="AUTH.redirectWithToken('http://'+window.location.hostname+':30081/login.html'); return false;" style="color: #fa8c16; font-weight: bold;">ç™»å½•</a>åå†è¿›è¡Œè®¢å•ç®¡ç†æ“ä½œ
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">è®¢å•æ€»æ•°</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">Â¥0</div>
                <div class="stat-label">æ€»é”€å”®é¢</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingOrders">0</div>
                <div class="stat-label">å¾…å¤„ç†è®¢å•</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedOrders">0</div>
                <div class="stat-label">å·²å®Œæˆè®¢å•</div>
            </div>
        </div>
        
        <div class="filter-bar">
            <div class="filter-group">
                <label for="statusFilter">è®¢å•çŠ¶æ€</label>
                <select id="statusFilter" onchange="filterOrders()">
                    <option value="">å…¨éƒ¨</option>
                    <option value="pending">å¾…æ”¯ä»˜</option>
                    <option value="paid">å·²æ”¯ä»˜</option>
                    <option value="shipped">å·²å‘è´§</option>
                    <option value="delivered">å·²é€è¾¾</option>
                    <option value="cancelled">å·²å–æ¶ˆ</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="userFilter">ç”¨æˆ·ç­›é€‰</label>
                <input type="text" id="userFilter" placeholder="è¾“å…¥ç”¨æˆ·åç­›é€‰..." onkeyup="filterOrders()">
            </div>
            <div class="filter-group">
                <label for="sortOrder">æ’åºæ–¹å¼</label>
                <select id="sortOrder" onchange="filterOrders()">
                    <option value="newest">æœ€æ–°ä¼˜å…ˆ</option>
                    <option value="oldest">æœ€æ—©ä¼˜å…ˆ</option>
                    <option value="amount-high">é‡‘é¢ä»é«˜åˆ°ä½</option>
                    <option value="amount-low">é‡‘é¢ä»ä½åˆ°é«˜</option>
                </select>
            </div>
        </div>
        
        <div id="orderList" class="order-list">
            <!-- è®¢å•åˆ—è¡¨å°†åœ¨è¿™é‡ŒåŠ¨æ€åŠ è½½ -->
        </div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <p style="font-size: 48px;">ğŸ“‹</p>
            <p>æš‚æ— è®¢å•</p>
            <p style="font-size: 14px; margin-top: 10px;">ç‚¹å‡»å³ä¸‹è§’æŒ‰é’®åˆ›å»ºç¬¬ä¸€ä¸ªè®¢å•</p>
        </div>
    </div>
    
    <button class="add-order-btn" onclick="showAddModal()">+</button>
    
    <!-- æ·»åŠ è®¢å•æ¨¡æ€æ¡† -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">åˆ›å»ºè®¢å•</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <form id="orderForm">
                <input type="hidden" id="orderId">
                <div class="form-group">
                    <label>è®¢å•å•†å“</label>
                    <div id="orderItems">
                        <div class="order-item-input">
                            <select class="product-select" required>
                                <option value="">é€‰æ‹©å•†å“...</option>
                            </select>
                            <input type="number" placeholder="æ•°é‡" min="1" value="1" required>
                            <input type="number" placeholder="å•ä»·" step="0.01" min="0" readonly>
                            <button type="button" class="remove-item-btn" onclick="removeOrderItem(this)">åˆ é™¤</button>
                        </div>
                    </div>
                    <button type="button" class="add-item-btn" onclick="addOrderItem()">+ æ·»åŠ å•†å“</button>
                </div>
                <div class="form-group">
                    <label for="shippingAddress">æ”¶è´§åœ°å€</label>
                    <textarea id="shippingAddress" placeholder="è¯·è¾“å…¥æ”¶è´§åœ°å€" required></textarea>
                </div>
                <div class="form-group">
                    <label for="notes">å¤‡æ³¨</label>
                    <textarea id="notes" placeholder="è®¢å•å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰"></textarea>
                </div>
                <div class="form-group">
                    <label>è®¢å•æ€»é¢</label>
                    <div style="font-size: 24px; color: #f5222d; font-weight: 600;">Â¥<span id="orderTotal">0.00</span></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">åˆ›å»ºè®¢å•</button>
            </form>
        </div>
    </div>
    
    <script src="/auth.js"></script>
    <script>
        const API_URL = window.location.origin;
        const PRODUCT_SERVICE_URL = 'http://' + window.location.hostname + ':30082';
        let orders = [];
        let products = [];
        
        // é¡µé¢åŠ è½½æ—¶è·å–æ•°æ®
        window.onload = function() {
            // åˆå§‹åŒ–é¡µé¢ï¼ˆä¸éœ€è¦å¼ºåˆ¶ç™»å½•ï¼‰
            AUTH.initPage(false);
            
            loadOrders();
            loadProducts();
            
            if (!AUTH.getToken()) {
                document.getElementById('authNotice').style.display = 'block';
            }
        };
        
        // æ˜¾ç¤ºæ¶ˆæ¯
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => {
                messageEl.innerHTML = '';
            }, 3000);
        }
        
        // åŠ è½½å•†å“åˆ—è¡¨
        async function loadProducts() {
            try {
                const response = await fetch(`${PRODUCT_SERVICE_URL}/api/products`);
                const data = await response.json();
                
                if (response.ok) {
                    products = data;
                    updateProductSelects();
                }
            } catch (error) {
                console.error('åŠ è½½å•†å“å¤±è´¥', error);
            }
        }
        
        // æ›´æ–°å•†å“é€‰æ‹©å™¨
        function updateProductSelects() {
            const selects = document.querySelectorAll('.product-select');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">é€‰æ‹©å•†å“...</option>' +
                    products.map(p => `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}">${p.name} - Â¥${p.price} (åº“å­˜:${p.stock})</option>`).join('');
                select.value = currentValue;
            });
        }
        
        // åŠ è½½è®¢å•åˆ—è¡¨
        async function loadOrders() {
            try {
                const response = await fetch(`${API_URL}/api/orders`);
                const data = await response.json();
                
                if (response.ok) {
                    orders = data;
                    filterOrders();
                    updateStats();
                } else {
                    showMessage('åŠ è½½è®¢å•å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // ç­›é€‰å’Œæ˜¾ç¤ºè®¢å•
        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const userFilter = document.getElementById('userFilter').value.toLowerCase();
            const sortOrder = document.getElementById('sortOrder').value;
            
            let filtered = orders.filter(order => {
                if (statusFilter && order.status !== statusFilter) return false;
                if (userFilter && !order.userId.toLowerCase().includes(userFilter)) return false;
                return true;
            });
            
            // æ’åº
            filtered.sort((a, b) => {
                switch (sortOrder) {
                    case 'oldest':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'amount-high':
                        return b.totalAmount - a.totalAmount;
                    case 'amount-low':
                        return a.totalAmount - b.totalAmount;
                    default: // newest
                        return new Date(b.createdAt) - new Date(a.createdAt);
                }
            });
            
            displayOrders(filtered);
        }
        
        // æ˜¾ç¤ºè®¢å•åˆ—è¡¨
        function displayOrders(ordersToShow) {
            const orderList = document.getElementById('orderList');
            const emptyState = document.getElementById('emptyState');
            
            if (ordersToShow.length === 0) {
                orderList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            orderList.style.display = 'block';
            emptyState.style.display = 'none';
            
            orderList.innerHTML = ordersToShow.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">è®¢å•å·: ${order.id}</div>
                            <div style="margin-top: 5px;">ç”¨æˆ·: <strong>${order.userId}</strong></div>
                        </div>
                        <div class="order-status status-${order.status}">${getStatusText(order.status)}</div>
                    </div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <div class="item-info">
                                    <div class="item-name">${item.productName || 'å•†å“ ' + item.productId}</div>
                                    <div class="item-quantity">æ•°é‡: ${item.quantity}</div>
                                </div>
                                <div class="item-price">Â¥${(item.price * item.quantity).toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="order-total">
                        <span>è®¢å•æ€»é¢: </span>
                        <span class="total-amount">Â¥${order.totalAmount.toFixed(2)}</span>
                    </div>
                    <div class="date-info">
                        åˆ›å»ºæ—¶é—´: ${new Date(order.createdAt).toLocaleString()}
                        ${order.updatedAt ? `<br>æ›´æ–°æ—¶é—´: ${new Date(order.updatedAt).toLocaleString()}` : ''}
                    </div>
                    ${AUTH.getToken() && order.userId === AUTH.getUser()?.username ? `
                        <div class="order-actions">
                            ${order.status === 'pending' ? `
                                <button class="btn btn-primary" onclick="updateOrderStatus('${order.id}', 'paid')">æ”¯ä»˜è®¢å•</button>
                                <button class="btn btn-danger" onclick="updateOrderStatus('${order.id}', 'cancelled')">å–æ¶ˆè®¢å•</button>
                            ` : ''}
                            ${order.status === 'paid' ? `
                                <button class="btn btn-success" onclick="updateOrderStatus('${order.id}', 'shipped')">å‘è´§</button>
                            ` : ''}
                            ${order.status === 'shipped' ? `
                                <button class="btn btn-success" onclick="updateOrderStatus('${order.id}', 'delivered')">ç¡®è®¤æ”¶è´§</button>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // è·å–çŠ¶æ€æ–‡æœ¬
        function getStatusText(status) {
            const statusMap = {
                'pending': 'å¾…æ”¯ä»˜',
                'paid': 'å·²æ”¯ä»˜',
                'shipped': 'å·²å‘è´§',
                'delivered': 'å·²é€è¾¾',
                'cancelled': 'å·²å–æ¶ˆ'
            };
            return statusMap[status] || status;
        }
        
        // æ›´æ–°ç»Ÿè®¡ä¿¡æ¯
        function updateStats() {
            const totalOrders = orders.length;
            const totalRevenue = orders.reduce((sum, o) => sum + (o.status !== 'cancelled' ? o.totalAmount : 0), 0);
            const pendingOrders = orders.filter(o => o.status === 'pending').length;
            const completedOrders = orders.filter(o => o.status === 'delivered').length;
            
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('totalRevenue').textContent = `Â¥${totalRevenue.toFixed(2)}`;
            document.getElementById('pendingOrders').textContent = pendingOrders;
            document.getElementById('completedOrders').textContent = completedOrders;
        }
        
        // æ˜¾ç¤ºæ·»åŠ æ¨¡æ€æ¡†
        function showAddModal() {
            if (!AUTH.checkAuth()) {
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'åˆ›å»ºè®¢å•';
            document.getElementById('orderForm').reset();
            document.getElementById('orderId').value = '';
            document.getElementById('orderItems').innerHTML = `
                <div class="order-item-input">
                    <select class="product-select" required onchange="updateItemPrice(this)">
                        <option value="">é€‰æ‹©å•†å“...</option>
                    </select>
                    <input type="number" placeholder="æ•°é‡" min="1" value="1" required onchange="calculateTotal()">
                    <input type="number" placeholder="å•ä»·" step="0.01" min="0" readonly>
                    <button type="button" class="remove-item-btn" onclick="removeOrderItem(this)">åˆ é™¤</button>
                </div>
            `;
            updateProductSelects();
            calculateTotal();
            document.getElementById('orderModal').style.display = 'flex';
        }
        
        // æ·»åŠ è®¢å•é¡¹
        function addOrderItem() {
            const itemHtml = `
                <div class="order-item-input">
                    <select class="product-select" required onchange="updateItemPrice(this)">
                        <option value="">é€‰æ‹©å•†å“...</option>
                    </select>
                    <input type="number" placeholder="æ•°é‡" min="1" value="1" required onchange="calculateTotal()">
                    <input type="number" placeholder="å•ä»·" step="0.01" min="0" readonly>
                    <button type="button" class="remove-item-btn" onclick="removeOrderItem(this)">åˆ é™¤</button>
                </div>
            `;
            document.getElementById('orderItems').insertAdjacentHTML('beforeend', itemHtml);
            updateProductSelects();
        }
        
        // åˆ é™¤è®¢å•é¡¹
        function removeOrderItem(btn) {
            const items = document.querySelectorAll('.order-item-input');
            if (items.length > 1) {
                btn.parentElement.remove();
                calculateTotal();
            }
        }
        
        // æ›´æ–°å•†å“ä»·æ ¼
        function updateItemPrice(select) {
            const priceInput = select.parentElement.querySelector('input[placeholder="å•ä»·"]');
            const selectedOption = select.options[select.selectedIndex];
            const price = selectedOption.dataset.price || 0;
            priceInput.value = price;
            calculateTotal();
        }
        
        // è®¡ç®—è®¢å•æ€»é¢
        function calculateTotal() {
            let total = 0;
            const items = document.querySelectorAll('.order-item-input');
            items.forEach(item => {
                const quantity = parseInt(item.querySelector('input[placeholder="æ•°é‡"]').value) || 0;
                const price = parseFloat(item.querySelector('input[placeholder="å•ä»·"]').value) || 0;
                total += quantity * price;
            });
            document.getElementById('orderTotal').textContent = total.toFixed(2);
        }
        
        // å…³é—­æ¨¡æ€æ¡†
        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }
        
        // ä¿å­˜è®¢å•
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const items = [];
            const itemElements = document.querySelectorAll('.order-item-input');
            
            for (const itemEl of itemElements) {
                const productId = itemEl.querySelector('.product-select').value;
                const quantity = parseInt(itemEl.querySelector('input[placeholder="æ•°é‡"]').value);
                const price = parseFloat(itemEl.querySelector('input[placeholder="å•ä»·"]').value);
                const productName = itemEl.querySelector('.product-select').selectedOptions[0].text.split(' - ')[0];
                
                if (productId) {
                    items.push({ productId, productName, quantity, price });
                }
            }
            
            if (items.length === 0) {
                showMessage('è¯·è‡³å°‘æ·»åŠ ä¸€ä¸ªå•†å“', 'error');
                return;
            }
            
            const orderData = {
                items,
                shippingAddress: document.getElementById('shippingAddress').value,
                notes: document.getElementById('notes').value
            };
            
            try {
                const response = await fetch(`${API_URL}/api/orders`, {
                    method: 'POST',
                    headers: AUTH.getAuthHeaders(),
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    showMessage('è®¢å•åˆ›å»ºæˆåŠŸ', 'success');
                    closeModal();
                    loadOrders();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'åˆ›å»ºå¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        });
        
        // æ›´æ–°è®¢å•çŠ¶æ€
        async function updateOrderStatus(orderId, newStatus) {
            if (!confirm(`ç¡®å®šè¦å°†è®¢å•çŠ¶æ€æ›´æ”¹ä¸º"${getStatusText(newStatus)}"å—ï¼Ÿ`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: AUTH.getAuthHeaders(),
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    showMessage('çŠ¶æ€æ›´æ–°æˆåŠŸ', 'success');
                    loadOrders();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'æ›´æ–°å¤±è´¥', 'error');
                }
            } catch (error) {
                showMessage('ç½‘ç»œé”™è¯¯', 'error');
            }
        }
        
        // ç‚¹å‡»æ¨¡æ€æ¡†å¤–éƒ¨å…³é—­
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // å®šæ—¶åˆ·æ–°è®¢å•åˆ—è¡¨
        setInterval(loadOrders, 30000);
    </script>
</body>
</html>