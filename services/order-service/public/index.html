<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ËÆ¢ÂçïÁÆ°ÁêÜÁ≥ªÁªü - ‰∫ëÂéüÁîüÂïÜÂüé</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: #f5f5f5;
            line-height: 1.6;
        }
        
        .header {
            background: #722ed1;
            color: white;
            padding: 20px 0;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .nav-links {
            margin-top: 10px;
        }
        
        .nav-links a {
            color: white;
            text-decoration: none;
            margin: 0 15px;
            padding: 5px 15px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            transition: background 0.3s;
        }
        
        .nav-links a:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .order-list {
            margin-top: 20px;
        }
        
        .order-card {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            transition: transform 0.2s, box-shadow 0.2s;
        }
        
        .order-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        }
        
        .order-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .order-id {
            font-size: 14px;
            color: #999;
        }
        
        .order-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        
        .status-pending {
            background: #fff7e6;
            color: #fa8c16;
        }
        
        .status-paid {
            background: #e6f7ff;
            color: #1890ff;
        }
        
        .status-shipped {
            background: #f6ffed;
            color: #52c41a;
        }
        
        .status-delivered {
            background: #f0f5ff;
            color: #2f54eb;
        }
        
        .status-cancelled {
            background: #fff1f0;
            color: #f5222d;
        }
        
        .order-items {
            margin: 15px 0;
        }
        
        .order-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px dashed #f0f0f0;
        }
        
        .order-item:last-child {
            border-bottom: none;
        }
        
        .item-info {
            flex: 1;
        }
        
        .item-name {
            font-weight: 500;
            color: #333;
        }
        
        .item-quantity {
            color: #666;
            font-size: 14px;
        }
        
        .item-price {
            color: #f5222d;
            font-weight: 600;
        }
        
        .order-total {
            text-align: right;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #f0f0f0;
        }
        
        .total-amount {
            font-size: 20px;
            color: #f5222d;
            font-weight: 600;
        }
        
        .order-actions {
            margin-top: 15px;
            display: flex;
            gap: 10px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background: #40a9ff;
        }
        
        .btn-success {
            background: #52c41a;
            color: white;
        }
        
        .btn-success:hover {
            background: #73d13d;
        }
        
        .btn-danger {
            background: #ff4d4f;
            color: white;
        }
        
        .btn-danger:hover {
            background: #ff7875;
        }
        
        .add-order-btn {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            background: #722ed1;
            color: white;
            border: none;
            border-radius: 50%;
            font-size: 30px;
            cursor: pointer;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            transition: all 0.3s;
        }
        
        .add-order-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 16px rgba(0,0,0,0.2);
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 8px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .close-btn {
            font-size: 24px;
            cursor: pointer;
            color: #999;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        label {
            display: block;
            margin-bottom: 5px;
            color: #666;
            font-weight: 500;
        }
        
        input, select, textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        
        textarea {
            resize: vertical;
            min-height: 80px;
        }
        
        .message {
            padding: 15px;
            margin: 20px 0;
            border-radius: 4px;
            text-align: center;
        }
        
        .success {
            background: #f6ffed;
            border: 1px solid #b7eb8f;
            color: #52c41a;
        }
        
        .error {
            background: #fff2e8;
            border: 1px solid #ffbb96;
            color: #fa541c;
        }
        
        .auth-notice {
            background: #fff7e6;
            border: 1px solid #ffd591;
            color: #fa8c16;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }
        
        .filter-bar {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .filter-group {
            flex: 1;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 32px;
            font-weight: 600;
            color: #722ed1;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .order-item-input {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            align-items: center;
        }
        
        .order-item-input input {
            flex: 1;
        }
        
        .remove-item-btn {
            background: #ff4d4f;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .add-item-btn {
            background: #52c41a;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-top: 10px;
        }
        
        .product-select {
            flex: 2;
        }
        
        .date-info {
            font-size: 12px;
            color: #999;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div id="nav-container"></div>
    <div class="header" style="display: none;">
        <h1>üõí ËÆ¢ÂçïÁÆ°ÁêÜÁ≥ªÁªü</h1>
        <p>‰∫ëÂéüÁîüÂæÆÊúçÂä°ÂïÜÂüé - ËÆ¢ÂçïÊúçÂä°</p>
        <div class="nav-links">
            <a href="#" onclick="AUTH.redirectWithToken('http://'+window.location.hostname+':30081'); return false;">üë§ Áî®Êà∑‰∏≠ÂøÉ</a>
            <a href="#" onclick="AUTH.redirectWithToken('http://'+window.location.hostname+':30082'); return false;">üì¶ ÂïÜÂìÅÁÆ°ÁêÜ</a>
        </div>
    </div>
    
    <div class="container">
        <div id="message"></div>
        
        <div id="authNotice" class="auth-notice" style="display: none;">
            ‚ö†Ô∏è ËØ∑ÂÖà<a href="#" onclick="AUTH.redirectWithToken('http://'+window.location.hostname+':30081/login.html'); return false;" style="color: #fa8c16; font-weight: bold;">ÁôªÂΩï</a>ÂêéÂÜçËøõË°åËÆ¢ÂçïÁÆ°ÁêÜÊìç‰Ωú
        </div>
        
        <div class="stats">
            <div class="stat-card">
                <div class="stat-value" id="totalOrders">0</div>
                <div class="stat-label">ËÆ¢ÂçïÊÄªÊï∞</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalRevenue">¬•0</div>
                <div class="stat-label">ÊÄªÈîÄÂîÆÈ¢ù</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="pendingOrders">0</div>
                <div class="stat-label">ÂæÖÂ§ÑÁêÜËÆ¢Âçï</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="completedOrders">0</div>
                <div class="stat-label">Â∑≤ÂÆåÊàêËÆ¢Âçï</div>
            </div>
        </div>
        
        <div class="filter-bar">
            <div class="filter-group">
                <label for="statusFilter">ËÆ¢ÂçïÁä∂ÊÄÅ</label>
                <select id="statusFilter" onchange="filterOrders()">
                    <option value="">ÂÖ®ÈÉ®</option>
                    <option value="pending">ÂæÖÊîØ‰ªò</option>
                    <option value="paid">Â∑≤ÊîØ‰ªò</option>
                    <option value="shipped">Â∑≤ÂèëË¥ß</option>
                    <option value="delivered">Â∑≤ÈÄÅËææ</option>
                    <option value="cancelled">Â∑≤ÂèñÊ∂à</option>
                </select>
            </div>
            <div class="filter-group">
                <label for="userFilter">Áî®Êà∑Á≠õÈÄâ</label>
                <input type="text" id="userFilter" placeholder="ËæìÂÖ•Áî®Êà∑ÂêçÁ≠õÈÄâ..." onkeyup="filterOrders()">
            </div>
            <div class="filter-group">
                <label for="sortOrder">ÊéíÂ∫èÊñπÂºè</label>
                <select id="sortOrder" onchange="filterOrders()">
                    <option value="newest">ÊúÄÊñ∞‰ºòÂÖà</option>
                    <option value="oldest">ÊúÄÊó©‰ºòÂÖà</option>
                    <option value="amount-high">ÈáëÈ¢ù‰ªéÈ´òÂà∞‰Ωé</option>
                    <option value="amount-low">ÈáëÈ¢ù‰ªé‰ΩéÂà∞È´ò</option>
                </select>
            </div>
        </div>
        
        <div id="orderList" class="order-list">
            <!-- ËÆ¢ÂçïÂàóË°®Â∞ÜÂú®ËøôÈáåÂä®ÊÄÅÂä†ËΩΩ -->
        </div>
        
        <div id="emptyState" class="empty-state" style="display: none;">
            <p style="font-size: 48px;">üìã</p>
            <p>ÊöÇÊó†ËÆ¢Âçï</p>
            <p style="font-size: 14px; margin-top: 10px;">ÁÇπÂáªÂè≥‰∏ãËßíÊåâÈíÆÂàõÂª∫Á¨¨‰∏Ä‰∏™ËÆ¢Âçï</p>
        </div>
    </div>
    
    <button class="add-order-btn" onclick="showAddModal()">+</button>
    
    <!-- Ê∑ªÂä†ËÆ¢ÂçïÊ®°ÊÄÅÊ°Ü -->
    <div id="orderModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 id="modalTitle">ÂàõÂª∫ËÆ¢Âçï</h2>
                <span class="close-btn" onclick="closeModal()">&times;</span>
            </div>
            <form id="orderForm">
                <input type="hidden" id="orderId">
                <div class="form-group">
                    <label>ËÆ¢ÂçïÂïÜÂìÅ</label>
                    <div id="orderItems">
                        <div class="order-item-input">
                            <select class="product-select" required>
                                <option value="">ÈÄâÊã©ÂïÜÂìÅ...</option>
                            </select>
                            <input type="number" placeholder="Êï∞Èáè" min="1" value="1" required>
                            <input type="number" placeholder="Âçï‰ª∑" step="0.01" min="0" readonly>
                            <button type="button" class="remove-item-btn" onclick="removeOrderItem(this)">Âà†Èô§</button>
                        </div>
                    </div>
                    <button type="button" class="add-item-btn" onclick="addOrderItem()">+ Ê∑ªÂä†ÂïÜÂìÅ</button>
                </div>
                <div class="form-group">
                    <label for="shippingAddress">Êî∂Ë¥ßÂú∞ÂùÄ</label>
                    <textarea id="shippingAddress" placeholder="ËØ∑ËæìÂÖ•Êî∂Ë¥ßÂú∞ÂùÄ" required></textarea>
                </div>
                <div class="form-group">
                    <label for="notes">Â§áÊ≥®</label>
                    <textarea id="notes" placeholder="ËÆ¢ÂçïÂ§áÊ≥®ÔºàÂèØÈÄâÔºâ"></textarea>
                </div>
                <div class="form-group">
                    <label>ËÆ¢ÂçïÊÄªÈ¢ù</label>
                    <div style="font-size: 24px; color: #f5222d; font-weight: 600;">¬•<span id="orderTotal">0.00</span></div>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%;">ÂàõÂª∫ËÆ¢Âçï</button>
            </form>
        </div>
    </div>
    
    <script src="/auth.js"></script>
    <script>
        const API_URL = window.location.origin;
        const PRODUCT_SERVICE_URL = 'http://' + window.location.hostname + ':30082';
        let orders = [];
        let products = [];
        
        // È°µÈù¢Âä†ËΩΩÊó∂Ëé∑ÂèñÊï∞ÊçÆ
        window.onload = function() {
            // ÂàùÂßãÂåñÈ°µÈù¢Ôºà‰∏çÈúÄË¶ÅÂº∫Âà∂ÁôªÂΩïÔºâ
            AUTH.initPage(false);
            
            loadOrders();
            loadProducts();
            
            if (!AUTH.getToken()) {
                document.getElementById('authNotice').style.display = 'block';
            }
        };
        
        // ÊòæÁ§∫Ê∂àÊÅØ
        function showMessage(text, type) {
            const messageEl = document.getElementById('message');
            messageEl.innerHTML = `<div class="message ${type}">${text}</div>`;
            setTimeout(() => {
                messageEl.innerHTML = '';
            }, 3000);
        }
        
        // Âä†ËΩΩÂïÜÂìÅÂàóË°®
        async function loadProducts() {
            try {
                const response = await fetch(`${PRODUCT_SERVICE_URL}/api/products`);
                const data = await response.json();
                
                if (response.ok) {
                    products = data;
                    updateProductSelects();
                }
            } catch (error) {
                console.error('Âä†ËΩΩÂïÜÂìÅÂ§±Ë¥•', error);
            }
        }
        
        // Êõ¥Êñ∞ÂïÜÂìÅÈÄâÊã©Âô®
        function updateProductSelects() {
            const selects = document.querySelectorAll('.product-select');
            selects.forEach(select => {
                const currentValue = select.value;
                select.innerHTML = '<option value="">ÈÄâÊã©ÂïÜÂìÅ...</option>' +
                    products.map(p => `<option value="${p.id}" data-price="${p.price}" data-stock="${p.stock}">${p.name} - ¬•${p.price} (Â∫ìÂ≠ò:${p.stock})</option>`).join('');
                select.value = currentValue;
            });
        }
        
        // Âä†ËΩΩËÆ¢ÂçïÂàóË°®
        async function loadOrders() {
            try {
                const response = await fetch(`${API_URL}/api/orders`);
                const data = await response.json();
                
                if (response.ok) {
                    orders = data;
                    filterOrders();
                    updateStats();
                } else {
                    showMessage('Âä†ËΩΩËÆ¢ÂçïÂ§±Ë¥•', 'error');
                }
            } catch (error) {
                showMessage('ÁΩëÁªúÈîôËØØ', 'error');
            }
        }
        
        // Á≠õÈÄâÂíåÊòæÁ§∫ËÆ¢Âçï
        function filterOrders() {
            const statusFilter = document.getElementById('statusFilter').value;
            const userFilter = document.getElementById('userFilter').value.toLowerCase();
            const sortOrder = document.getElementById('sortOrder').value;
            
            let filtered = orders.filter(order => {
                if (statusFilter && order.status !== statusFilter) return false;
                if (userFilter && !order.userId.toLowerCase().includes(userFilter)) return false;
                return true;
            });
            
            // ÊéíÂ∫è
            filtered.sort((a, b) => {
                switch (sortOrder) {
                    case 'oldest':
                        return new Date(a.createdAt) - new Date(b.createdAt);
                    case 'amount-high':
                        return b.totalAmount - a.totalAmount;
                    case 'amount-low':
                        return a.totalAmount - b.totalAmount;
                    default: // newest
                        return new Date(b.createdAt) - new Date(a.createdAt);
                }
            });
            
            displayOrders(filtered);
        }
        
        // ÊòæÁ§∫ËÆ¢ÂçïÂàóË°®
        function displayOrders(ordersToShow) {
            const orderList = document.getElementById('orderList');
            const emptyState = document.getElementById('emptyState');
            
            if (ordersToShow.length === 0) {
                orderList.style.display = 'none';
                emptyState.style.display = 'block';
                return;
            }
            
            orderList.style.display = 'block';
            emptyState.style.display = 'none';
            
            orderList.innerHTML = ordersToShow.map(order => `
                <div class="order-card">
                    <div class="order-header">
                        <div>
                            <div class="order-id">ËÆ¢ÂçïÂè∑: ${order.id}</div>
                            <div style="margin-top: 5px;">Áî®Êà∑: <strong>${order.userId}</strong></div>
                        </div>
                        <div class="order-status status-${order.status}">${getStatusText(order.status)}</div>
                    </div>
                    <div class="order-items">
                        ${order.items.map(item => `
                            <div class="order-item">
                                <div class="item-info">
                                    <div class="item-name">${item.productName || 'ÂïÜÂìÅ ' + item.productId}</div>
                                    <div class="item-quantity">Êï∞Èáè: ${item.quantity}</div>
                                </div>
                                <div class="item-price">¬•${(item.price * item.quantity).toFixed(2)}</div>
                            </div>
                        `).join('')}
                    </div>
                    <div class="order-total">
                        <span>ËÆ¢ÂçïÊÄªÈ¢ù: </span>
                        <span class="total-amount">¬•${order.totalAmount.toFixed(2)}</span>
                    </div>
                    <div class="date-info">
                        ÂàõÂª∫Êó∂Èó¥: ${new Date(order.createdAt).toLocaleString()}
                        ${order.updatedAt ? `<br>Êõ¥Êñ∞Êó∂Èó¥: ${new Date(order.updatedAt).toLocaleString()}` : ''}
                    </div>
                    ${AUTH.getToken() && order.userId === AUTH.getUser()?.username ? `
                        <div class="order-actions">
                            ${order.status === 'pending' ? `
                                <button class="btn btn-primary" onclick="updateOrderStatus('${order.id}', 'paid')">ÊîØ‰ªòËÆ¢Âçï</button>
                                <button class="btn btn-danger" onclick="updateOrderStatus('${order.id}', 'cancelled')">ÂèñÊ∂àËÆ¢Âçï</button>
                            ` : ''}
                            ${order.status === 'paid' ? `
                                <button class="btn btn-success" onclick="updateOrderStatus('${order.id}', 'shipped')">ÂèëË¥ß</button>
                            ` : ''}
                            ${order.status === 'shipped' ? `
                                <button class="btn btn-success" onclick="updateOrderStatus('${order.id}', 'delivered')">Á°ÆËÆ§Êî∂Ë¥ß</button>
                            ` : ''}
                        </div>
                    ` : ''}
                </div>
            `).join('');
        }
        
        // Ëé∑ÂèñÁä∂ÊÄÅÊñáÊú¨
        function getStatusText(status) {
            const statusMap = {
                'pending': 'ÂæÖÊîØ‰ªò',
                'paid': 'Â∑≤ÊîØ‰ªò',
                'shipped': 'Â∑≤ÂèëË¥ß',
                'delivered': 'Â∑≤ÈÄÅËææ',
                'cancelled': 'Â∑≤ÂèñÊ∂à'
            };
            return statusMap[status] || status;
        }
        
        // Êõ¥Êñ∞ÁªüËÆ°‰ø°ÊÅØ
        function updateStats() {
            const totalOrders = orders.length;
            const totalRevenue = orders.reduce((sum, o) => sum + (o.status !== 'cancelled' ? o.totalAmount : 0), 0);
            const pendingOrders = orders.filter(o => o.status === 'pending').length;
            const completedOrders = orders.filter(o => o.status === 'delivered').length;
            
            document.getElementById('totalOrders').textContent = totalOrders;
            document.getElementById('totalRevenue').textContent = `¬•${totalRevenue.toFixed(2)}`;
            document.getElementById('pendingOrders').textContent = pendingOrders;
            document.getElementById('completedOrders').textContent = completedOrders;
        }
        
        // ÊòæÁ§∫Ê∑ªÂä†Ê®°ÊÄÅÊ°Ü
        function showAddModal() {
            if (!AUTH.checkAuth()) {
                return;
            }
            
            document.getElementById('modalTitle').textContent = 'ÂàõÂª∫ËÆ¢Âçï';
            document.getElementById('orderForm').reset();
            document.getElementById('orderId').value = '';
            document.getElementById('orderItems').innerHTML = `
                <div class="order-item-input">
                    <select class="product-select" required onchange="updateItemPrice(this)">
                        <option value="">ÈÄâÊã©ÂïÜÂìÅ...</option>
                    </select>
                    <input type="number" placeholder="Êï∞Èáè" min="1" value="1" required onchange="calculateTotal()">
                    <input type="number" placeholder="Âçï‰ª∑" step="0.01" min="0" readonly>
                    <button type="button" class="remove-item-btn" onclick="removeOrderItem(this)">Âà†Èô§</button>
                </div>
            `;
            updateProductSelects();
            calculateTotal();
            document.getElementById('orderModal').style.display = 'flex';
        }
        
        // Ê∑ªÂä†ËÆ¢ÂçïÈ°π
        function addOrderItem() {
            const itemHtml = `
                <div class="order-item-input">
                    <select class="product-select" required onchange="updateItemPrice(this)">
                        <option value="">ÈÄâÊã©ÂïÜÂìÅ...</option>
                    </select>
                    <input type="number" placeholder="Êï∞Èáè" min="1" value="1" required onchange="calculateTotal()">
                    <input type="number" placeholder="Âçï‰ª∑" step="0.01" min="0" readonly>
                    <button type="button" class="remove-item-btn" onclick="removeOrderItem(this)">Âà†Èô§</button>
                </div>
            `;
            document.getElementById('orderItems').insertAdjacentHTML('beforeend', itemHtml);
            updateProductSelects();
        }
        
        // Âà†Èô§ËÆ¢ÂçïÈ°π
        function removeOrderItem(btn) {
            const items = document.querySelectorAll('.order-item-input');
            if (items.length > 1) {
                btn.parentElement.remove();
                calculateTotal();
            }
        }
        
        // Êõ¥Êñ∞ÂïÜÂìÅ‰ª∑Ê†º
        function updateItemPrice(select) {
            const priceInput = select.parentElement.querySelector('input[placeholder="Âçï‰ª∑"]');
            const selectedOption = select.options[select.selectedIndex];
            const price = selectedOption.dataset.price || 0;
            priceInput.value = price;
            calculateTotal();
        }
        
        // ËÆ°ÁÆóËÆ¢ÂçïÊÄªÈ¢ù
        function calculateTotal() {
            let total = 0;
            const items = document.querySelectorAll('.order-item-input');
            items.forEach(item => {
                const quantity = parseInt(item.querySelector('input[placeholder="Êï∞Èáè"]').value) || 0;
                const price = parseFloat(item.querySelector('input[placeholder="Âçï‰ª∑"]').value) || 0;
                total += quantity * price;
            });
            document.getElementById('orderTotal').textContent = total.toFixed(2);
        }
        
        // ÂÖ≥Èó≠Ê®°ÊÄÅÊ°Ü
        function closeModal() {
            document.getElementById('orderModal').style.display = 'none';
        }
        
        // ‰øùÂ≠òËÆ¢Âçï
        document.getElementById('orderForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const items = [];
            const itemElements = document.querySelectorAll('.order-item-input');
            
            for (const itemEl of itemElements) {
                const productId = itemEl.querySelector('.product-select').value;
                const quantity = parseInt(itemEl.querySelector('input[placeholder="Êï∞Èáè"]').value);
                const price = parseFloat(itemEl.querySelector('input[placeholder="Âçï‰ª∑"]').value);
                const productName = itemEl.querySelector('.product-select').selectedOptions[0].text.split(' - ')[0];
                
                if (productId) {
                    items.push({ productId, productName, quantity, price });
                }
            }
            
            if (items.length === 0) {
                showMessage('ËØ∑Ëá≥Â∞ëÊ∑ªÂä†‰∏Ä‰∏™ÂïÜÂìÅ', 'error');
                return;
            }
            
            const orderData = {
                items,
                shippingAddress: document.getElementById('shippingAddress').value,
                notes: document.getElementById('notes').value
            };
            
            try {
                const response = await fetch(`${API_URL}/api/orders`, {
                    method: 'POST',
                    headers: AUTH.getAuthHeaders(),
                    body: JSON.stringify(orderData)
                });
                
                if (response.ok) {
                    showMessage('ËÆ¢ÂçïÂàõÂª∫ÊàêÂäü', 'success');
                    closeModal();
                    loadOrders();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'ÂàõÂª∫Â§±Ë¥•', 'error');
                }
            } catch (error) {
                showMessage('ÁΩëÁªúÈîôËØØ', 'error');
            }
        });
        
        // Êõ¥Êñ∞ËÆ¢ÂçïÁä∂ÊÄÅ
        async function updateOrderStatus(orderId, newStatus) {
            if (!confirm(`Á°ÆÂÆöË¶ÅÂ∞ÜËÆ¢ÂçïÁä∂ÊÄÅÊõ¥Êîπ‰∏∫"${getStatusText(newStatus)}"ÂêóÔºü`)) return;
            
            try {
                const response = await fetch(`${API_URL}/api/orders/${orderId}/status`, {
                    method: 'PUT',
                    headers: AUTH.getAuthHeaders(),
                    body: JSON.stringify({ status: newStatus })
                });
                
                if (response.ok) {
                    showMessage('Áä∂ÊÄÅÊõ¥Êñ∞ÊàêÂäü', 'success');
                    loadOrders();
                } else {
                    const data = await response.json();
                    showMessage(data.error || 'Êõ¥Êñ∞Â§±Ë¥•', 'error');
                }
            } catch (error) {
                showMessage('ÁΩëÁªúÈîôËØØ', 'error');
            }
        }
        
        // ÁÇπÂáªÊ®°ÊÄÅÊ°ÜÂ§ñÈÉ®ÂÖ≥Èó≠
        window.onclick = function(event) {
            const modal = document.getElementById('orderModal');
            if (event.target === modal) {
                closeModal();
            }
        }
        
        // ÂÆöÊó∂Âà∑Êñ∞ËÆ¢ÂçïÂàóË°®
        setInterval(loadOrders, 30000);
    </script>
</body>
</html>