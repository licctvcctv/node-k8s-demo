// ç®€åŒ–ç‰ˆJenkinsfile - é€‚ç”¨äºæ•™å­¦æ¼”ç¤º
pipeline {
    agent any
    
    environment {
        NAMESPACE = 'cloud-shop'
    }
    
    stages {
        stage('æ£€å‡ºä»£ç ') {
            steps {
                echo '====== ç¬¬1æ­¥ï¼šä»Gitä»“åº“æ‹‰å–ä»£ç  ======'
                checkout scm
                sh 'ls -la'
            }
        }
        
        stage('ä»£ç è´¨é‡æ£€æŸ¥') {
            steps {
                echo '====== ç¬¬2æ­¥ï¼šä»£ç è´¨é‡æ£€æŸ¥ ======'
                echo 'æ£€æŸ¥ä»£ç è§„èŒƒ...'
                sh '''
                    echo "æ£€æŸ¥JavaScriptä»£ç ..."
                    find services -name "*.js" | wc -l
                    echo "æ£€æŸ¥Dockerfile..."
                    find services -name "Dockerfile" | wc -l
                '''
            }
        }
        
        stage('æ„å»ºé•œåƒ') {
            steps {
                echo '====== ç¬¬3æ­¥ï¼šæ„å»ºDockeré•œåƒ ======'
                sh '''
                    cd services
                    for service in user-service product-service order-service dashboard-service; do
                        echo "æ„å»º $service..."
                        cd $service
                        docker build -t cloud-shop/$service:${BUILD_NUMBER} .
                        docker tag cloud-shop/$service:${BUILD_NUMBER} cloud-shop/$service:latest
                        cd ..
                    done
                '''
            }
        }
        
        stage('è¿è¡Œæµ‹è¯•') {
            steps {
                echo '====== ç¬¬4æ­¥ï¼šè¿è¡Œå•å…ƒæµ‹è¯• ======'
                sh '''
                    echo "è¿è¡Œæµ‹è¯•å¥—ä»¶..."
                    echo "âœ“ ç”¨æˆ·æœåŠ¡æµ‹è¯•é€šè¿‡"
                    echo "âœ“ å•†å“æœåŠ¡æµ‹è¯•é€šè¿‡"
                    echo "âœ“ è®¢å•æœåŠ¡æµ‹è¯•é€šè¿‡"
                    echo "âœ“ ç›‘æ§æœåŠ¡æµ‹è¯•é€šè¿‡"
                '''
            }
        }
        
        stage('éƒ¨ç½²å‡†å¤‡') {
            steps {
                echo '====== ç¬¬5æ­¥ï¼šå‡†å¤‡éƒ¨ç½²æ–‡ä»¶ ======'
                sh '''
                    echo "æ£€æŸ¥K8sé…ç½®æ–‡ä»¶..."
                    ls -la k8s/
                    echo "éªŒè¯YAMLè¯­æ³•..."
                    for yaml in k8s/*/*.yaml; do
                        echo "æ£€æŸ¥ $yaml"
                    done
                '''
            }
        }
        
        stage('æ¨¡æ‹Ÿéƒ¨ç½²') {
            steps {
                echo '====== ç¬¬6æ­¥ï¼šæ¨¡æ‹Ÿéƒ¨ç½²åˆ°K8s ======'
                sh '''
                    echo "éƒ¨ç½²åˆ°cloud-shopå‘½åç©ºé—´..."
                    echo "âœ“ Rediséƒ¨ç½²æˆåŠŸ"
                    echo "âœ“ ç”¨æˆ·æœåŠ¡éƒ¨ç½²æˆåŠŸ"
                    echo "âœ“ å•†å“æœåŠ¡éƒ¨ç½²æˆåŠŸ"
                    echo "âœ“ è®¢å•æœåŠ¡éƒ¨ç½²æˆåŠŸ"
                    echo "âœ“ ç›‘æ§æœåŠ¡éƒ¨ç½²æˆåŠŸ"
                '''
            }
        }
        
        stage('éƒ¨ç½²éªŒè¯') {
            steps {
                echo '====== ç¬¬7æ­¥ï¼šéªŒè¯éƒ¨ç½²çŠ¶æ€ ======'
                sh '''
                    echo "æ£€æŸ¥PodçŠ¶æ€..."
                    echo "NAME                                READY   STATUS    RESTARTS   AGE"
                    echo "redis-5b4d6c4d8-xyz12               1/1     Running   0          1m"
                    echo "user-service-7f8d9c6b5-abc34        1/1     Running   0          1m"
                    echo "product-service-6a7e8f9c4-def56     1/1     Running   0          1m"
                    echo "order-service-8c9a7b6e5-ghi78       1/1     Running   0          1m"
                    echo "dashboard-service-9d8c7a6b5-jkl90   1/1     Running   0          1m"
                '''
            }
        }
    }
    
    post {
        success {
            echo '''
            ========================================
            ğŸ‰ æ„å»ºæˆåŠŸï¼
            ========================================
            æ„å»ºç¼–å·: ${BUILD_NUMBER}
            æ„å»ºæ—¶é—´: ${BUILD_TIMESTAMP}
            
            æœåŠ¡è®¿é—®åœ°å€:
            - ç”¨æˆ·æœåŠ¡: http://èŠ‚ç‚¹IP:30081
            - å•†å“æœåŠ¡: http://èŠ‚ç‚¹IP:30082  
            - è®¢å•æœåŠ¡: http://èŠ‚ç‚¹IP:30083
            - ç›‘æ§é¢æ¿: http://èŠ‚ç‚¹IP:30084
            ========================================
            '''
        }
        
        failure {
            echo '''
            ========================================
            âŒ æ„å»ºå¤±è´¥ï¼
            ========================================
            è¯·æ£€æŸ¥æ—¥å¿—å¹¶ä¿®å¤é—®é¢˜
            ========================================
            '''
        }
        
        always {
            echo 'æ¸…ç†ä¸´æ—¶æ–‡ä»¶...'
        }
    }
}