# 系统架构说明

## 整体架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端 (浏览器/App)                        │
└─────────────────────────────────────────────────────────────────┘
                                   │
                                   ▼
┌─────────────────────────────────────────────────────────────────┐
│                     Kubernetes Cluster (K3s)                     │
│  ┌─────────────────────────────────────────────────────────┐   │
│  │                      Ingress/NodePort                     │   │
│  └─────────────────────────────────────────────────────────┘   │
│                                   │                              │
│        ┌──────────────┬──────────┴────────┬──────────────┐     │
│        ▼              ▼                   ▼              ▼     │
│  ┌──────────┐  ┌──────────┐      ┌──────────┐   ┌──────────┐ │
│  │   User   │  │ Product  │      │  Order   │   │  Redis   │ │
│  │ Service  │  │ Service  │      │ Service  │   │Database  │ │
│  │  (8081)  │  │  (8082)  │      │  (8083)  │   │  (6379)  │ │
│  └──────────┘  └──────────┘      └──────────┘   └──────────┘ │
│        │              │                   │              ▲     │
│        └──────────────┴───────────────────┴──────────────┘     │
└─────────────────────────────────────────────────────────────────┘
```

## 服务间通信流程

### 1. 用户注册/登录流程
```
Client → User Service → Redis
         ↓
       JWT Token
         ↓
       Client
```

### 2. 创建订单流程
```
Client (with JWT) → Order Service → User Service (验证JWT)
                         ↓
                   Product Service (验证商品/库存)
                         ↓
                      Redis (保存订单)
```

## 技术栈详情

### 微服务层
- **框架**: Node.js + Express
- **认证**: JWT (JSON Web Tokens)
- **数据验证**: 内置验证中间件
- **日志**: Morgan
- **安全**: Helmet, CORS

### 数据层
- **Redis**: 用作主数据库和缓存
  - 用户数据: `user:{username}`
  - 商品数据: `product:{id}`
  - 订单数据: `order:{id}`
  - 用户订单索引: `user:{username}:orders`

### 容器层
- **Docker**: 多阶段构建，最小化镜像
- **健康检查**: 每个服务都有 /health 端点

### 编排层
- **K3s**: 轻量级 Kubernetes
- **部署策略**: Rolling Update
- **服务发现**: Kubernetes Service
- **负载均衡**: 内置

### CI/CD
- **Jenkins Pipeline**: 并行构建和测试
- **阶段**:
  1. 代码检出
  2. 并行测试
  3. 并行构建镜像
  4. 部署到K8s
  5. 健康检查

### 监控
- **Prometheus**: 指标收集
- **Grafana**: 可视化面板
- **指标类型**:
  - 服务健康状态
  - 请求速率
  - 响应时间
  - 错误率

## 部署架构

### 虚拟机分配
```
VM1 (Master) - 192.168.200.128
├── K3s Master
├── Jenkins
├── Prometheus
└── Grafana

VM2 (Worker1) - 192.168.200.132
├── K3s Worker
├── User Service (副本1)
├── Product Service (副本1)
└── Order Service (副本1)

VM3 (Worker2) - 192.168.200.150
├── K3s Worker
├── Redis
├── User Service (副本2)
├── Product Service (副本2)
└── Order Service (副本2)
```

## 安全考虑

1. **认证**: JWT Token，24小时过期
2. **网络隔离**: Kubernetes Network Policies
3. **最小权限**: 非root用户运行容器
4. **密钥管理**: Kubernetes Secrets
5. **HTTPS**: 生产环境需配置TLS

## 扩展性

1. **水平扩展**: 通过增加Pod副本数
2. **垂直扩展**: 调整资源限制
3. **数据库扩展**: Redis集群模式
4. **服务网格**: 可集成Istio/Linkerd

## 高可用性

1. **服务副本**: 每个服务2个副本
2. **健康检查**: Liveness和Readiness探针
3. **自动重启**: Kubernetes自动恢复
4. **负载均衡**: Service自动分发请求